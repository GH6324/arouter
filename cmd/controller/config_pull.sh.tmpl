#!/usr/bin/env bash
set -euo pipefail

ensure_jq() {
  if command -v jq >/dev/null 2>&1; then
    return 0
  fi
  SUDO=""
  if command -v sudo >/dev/null 2>&1; then
    SUDO="sudo"
  fi
  if command -v apt-get >/dev/null 2>&1; then
    $SUDO apt-get update -y >/dev/null 2>&1 || true
    $SUDO apt-get install -y jq >/dev/null 2>&1 || true
  elif command -v yum >/dev/null 2>&1; then
    $SUDO yum install -y jq >/dev/null 2>&1 || true
  elif command -v dnf >/dev/null 2>&1; then
    $SUDO dnf install -y jq >/dev/null 2>&1 || true
  elif command -v apk >/dev/null 2>&1; then
    $SUDO apk add --no-cache jq >/dev/null 2>&1 || true
  elif command -v brew >/dev/null 2>&1; then
    brew install jq >/dev/null 2>&1 || true
  fi
}

ensure_jq

OS=$(uname -s | tr '[:upper:]' '[:lower:]')
INSTALL_DIR="__INSTALL_DIR__"
CONFIG_URL="__CONFIG_URL__"
TOKEN_OVERRIDE="__TOKEN__"
mkdir -p "${INSTALL_DIR}"

# ensure os/dir hint exists
SEP="?"
[[ "${CONFIG_URL}" == *"?"* ]] && SEP="&"
if [[ "${CONFIG_URL}" != *"os="* ]]; then
  CONFIG_URL="${CONFIG_URL}${SEP}os=${OS}"
  SEP="&"
fi
if [[ "${CONFIG_URL}" != *"install_dir="* ]]; then
  CONFIG_URL="${CONFIG_URL}${SEP}install_dir=$(printf '%s' "${INSTALL_DIR}" | sed 's/ /%20/g')"
fi

TOKEN="$(cat ${INSTALL_DIR}/.token 2>/dev/null || true)"
if [ -n "${TOKEN_OVERRIDE}" ]; then TOKEN="${TOKEN_OVERRIDE}"; fi

TMP=$(mktemp)
TMP_NORM=$(mktemp)
CUR_NORM=$(mktemp)
if [ -n "${TOKEN}" ]; then
  CURL_CMD=(curl -v -fsSL --connect-timeout 10 --max-time 30 -H "Authorization: Bearer ${TOKEN}" "${CONFIG_URL}")
else
  CURL_CMD=(curl -v -fsSL --connect-timeout 10 --max-time 30 "${CONFIG_URL}")
fi

if "${CURL_CMD[@]}" -o "$TMP"; then
  if command -v jq >/dev/null 2>&1; then
    jq -cS . "$TMP" > "$TMP_NORM" || cp "$TMP" "$TMP_NORM"
    if [ -f "${INSTALL_DIR}/config.json" ]; then
      jq -cS . "${INSTALL_DIR}/config.json" > "$CUR_NORM" || cp "${INSTALL_DIR}/config.json" "$CUR_NORM"
    fi
  else
    cp "$TMP" "$TMP_NORM"
    if [ -f "${INSTALL_DIR}/config.json" ]; then
      cp "${INSTALL_DIR}/config.json" "$CUR_NORM"
    fi
  fi
  if [ ! -f "$CUR_NORM" ] || ! cmp -s "$TMP_NORM" "$CUR_NORM"; then
    echo "[config-sync] config changed, updating and restarting..."
    mv "$TMP" "${INSTALL_DIR}/config.json"
    if command -v systemctl >/dev/null 2>&1; then
      systemctl restart arouter
    elif command -v launchctl >/dev/null 2>&1; then
      sudo launchctl kickstart -k system/com.arouter.node || true
    else
      echo "[config-sync] no service manager found, please restart manually" >&2
    fi
  else
    echo "[config-sync] no change"
    rm -f "$TMP"
  fi
else
  echo "[config-sync] fetch failed: CONFIG_URL=${CONFIG_URL}"
  rm -f "$TMP"
fi

rm -f "$TMP_NORM" "$CUR_NORM" 2>/dev/null || true
