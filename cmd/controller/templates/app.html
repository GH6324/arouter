{{ define "app.html" }}
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ARouter 控制台</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.20.2/reset.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.20.2/antd.min.css" />
  <style>
    body { margin:0; }
    #root { min-height:100vh; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.20.2/antd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.9/babel.min.js"></script>
  <script type="text/babel">
const { useState, useEffect } = React;
const { Layout, Menu, Table, Button, Modal, Form, Input, Space, message, Tabs, Tag, Card, Descriptions } = antd;

async function api(method, url, body) {
  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : undefined,
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json ? res.json() : {};
}

function NodeList({ onSelect }) {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [probes, setProbes] = useState([]);
  const [probeLoading, setProbeLoading] = useState(false);
  const [modalOpen, setModalOpen] = useState(false);
  const [form] = Form.useForm();

  const load = async () => {
    setLoading(true);
    try {
      const res = await api('GET', '/api/nodes');
      setData(res);
    } catch (e) { message.error(e.message); }
    setLoading(false);
  };
  const loadProbes = async () => {
    setProbeLoading(true);
    try {
      const res = await api('GET', '/api/probes');
      setProbes(res);
    } catch (e) { message.error(e.message); }
    setProbeLoading(false);
  };
  useEffect(() => { load(); }, []);
  useEffect(() => { loadProbes(); }, []);

  const columns = [
    { title: '名称', dataIndex: 'name' },
    { title: 'WS监听', dataIndex: 'ws_listen' },
    { title: 'Metrics', dataIndex: 'metrics_listen' },
    {
      title: '操作',
      render: (_, record) => (
        <Space>
          <Button size="small" onClick={() => onSelect(record)}>管理</Button>
          <Button size="small" href={`/nodes/${record.id}/config`} target="_blank">配置</Button>
          <Button size="small" href={`/nodes/${record.id}/install.sh`} target="_blank">安装脚本</Button>
        </Space>
      )
    }
  ];

  const onCreate = async () => {
    try {
      const values = await form.validateFields();
      await api('POST', '/api/nodes', values);
      message.success('节点已创建');
      setModalOpen(false);
      form.resetFields();
      load();
      loadProbes();
    } catch (e) { message.error(e.message); }
  };

  const runProbe = async (row) => {
    const path = row.path || [];
    const target = path.length ? path[path.length-1] : row.route;
    try {
      await api('POST', '/api/probe/request', { node: row.node, target });
      message.success('已发送测试指令');
      setTimeout(loadProbes, 2000);
    } catch (e) { message.error(e.message); }
  };

  const probeColumns = [
    { title: '节点', dataIndex: 'node' },
    { title: '线路', dataIndex: 'route' },
    { title: '路径', dataIndex: 'path', render: p => (p||[]).join(' -> ') },
    { title: '延迟(ms)', dataIndex: 'rtt_ms' },
    { title: '状态', dataIndex: 'success', render: v => v ? <Tag color="green">成功</Tag> : <Tag color="red">失败</Tag> },
    { title: '更新时间', dataIndex: 'updated_at' },
    { title: '操作', render: (_, row) => <Button size="small" onClick={()=>runProbe(row)}>测试</Button> },
  ];

  return (
    <Space direction="vertical" style={{width:"100%"}}>
      <Card
        title="节点"
        extra={<Button type="primary" onClick={() => setModalOpen(true)}>新建节点</Button>}
      >
        <Table rowKey="id" dataSource={data} columns={columns} loading={loading} pagination={false}/>
        <Modal open={modalOpen} onCancel={() => setModalOpen(false)} onOk={onCreate} title="新建节点">
        <Form layout="vertical" form={form} initialValues={{ ws_listen: "18080", metrics_listen: "19090" }}>
          <Form.Item name="name" label="节点名称" rules={[{ required: true }]}><Input/></Form.Item>
          <Form.Item name="ws_listen" label="WS监听"/><Form.Item name="metrics_listen" label="Metrics监听"/>
          <Form.Item name="mem_limit" label="内存上限" tooltip="如 256MiB，可选"><Input placeholder="256MiB"/></Form.Item>
          <Form.Item name="max_mux_streams" label="Max mux streams" tooltip="单连接并发流数，建议1-2"><Input placeholder="2"/></Form.Item>
          <Form.Item name="mux_max_age" label="Mux最⼤存活" tooltip="如 5m，可选"><Input placeholder="5m"/></Form.Item>
          <Form.Item name="mux_max_idle" label="Mux空闲超时" tooltip="如 1m，可选"><Input placeholder="1m"/></Form.Item>
        </Form>
      </Modal>
      </Card>

      <Card title="线路延迟">
        <Space style={{marginBottom:8}}>
          <Button onClick={loadProbes} loading={probeLoading}>刷新</Button>
        </Space>
        <Table rowKey="id" dataSource={probes} columns={probeColumns} loading={probeLoading} pagination={false}/>
      </Card>
    </Space>
  );
}

function NodeDetail({ node, onBack, refreshList }) {
  const [detail, setDetail] = useState(node);
  const [entryOpen, setEntryOpen] = useState(false);
  const [peerOpen, setPeerOpen] = useState(false);
  const [entryForm] = Form.useForm();
  const [peerForm] = Form.useForm();

  const load = async () => {
    try {
      const res = await api('GET', `/api/nodes/${node.id}`);
      setDetail(res);
      refreshList();
    } catch (e) { message.error(e.message); }
  };
  useEffect(() => { load(); }, [node.id]);

  const columnsEntry = [
    { title: '监听', dataIndex: 'listen' },
    { title: '协议', dataIndex: 'proto' },
    { title: '出口节点', dataIndex: 'exit' },
    { title: '远端', dataIndex: 'remote' },
  ];
  const columnsPeer = [
    { title: '名称', dataIndex: 'peer_name' },
    { title: '入口IP', dataIndex: 'entry_ip' },
    { title: '出口IP', dataIndex: 'exit_ip' },
    { title: 'WS地址', dataIndex: 'endpoint' },
  ];

  const addEntry = async () => {
    try {
      const v = await entryForm.validateFields();
      await api('POST', `/api/nodes/${node.id}/entries`, v);
      message.success('入口已添加');
      setEntryOpen(false); entryForm.resetFields(); load();
    } catch (e) { message.error(e.message); }
  };
  const addPeer = async () => {
    try {
      const v = await peerForm.validateFields();
      await api('POST', `/api/nodes/${node.id}/peers`, v);
      message.success('对端已添加');
      setPeerOpen(false); peerForm.resetFields(); load();
    } catch (e) { message.error(e.message); }
  };

  const removeNode = async () => {
    Modal.confirm({
      title: '确认删除节点？',
      onOk: async () => {
        await api('DELETE', `/api/nodes/${node.id}`);
        message.success('已删除');
        onBack();
        refreshList();
      }
    });
  };

  return (
    <Card title={`节点：${detail.name}`} extra={<Space>
      <Button onClick={onBack}>返回</Button>
      <Button href={`/nodes/${detail.id}/config`} target="_blank">下载配置</Button>
      <Button href={`/nodes/${detail.id}/install.sh`} target="_blank">安装脚本</Button>
      <Button danger onClick={removeNode}>删除</Button>
    </Space>}>
      <Descriptions column={2} bordered size="small">
        <Descriptions.Item label="WS监听">{detail.ws_listen}</Descriptions.Item>
        <Descriptions.Item label="Metrics">{detail.metrics_listen}</Descriptions.Item>
        <Descriptions.Item label="AuthKey">{detail.auth_key}</Descriptions.Item>
        <Descriptions.Item label="UDP TTL">{detail.udp_session_ttl}</Descriptions.Item>
      </Descriptions>

      <Tabs style={{marginTop:16}} items={[
        { key:'entries', label:'入口', children:<>
          <Button type="primary" onClick={()=>setEntryOpen(true)} style={{marginBottom:8}}>添加入口</Button>
          <Table rowKey="id" dataSource={detail.entries||[]} columns={columnsEntry} pagination={false}/>
        </>},
        { key:'peers', label:'对端', children:<>
          <Button type="primary" onClick={()=>setPeerOpen(true)} style={{marginBottom:8}}>添加对端</Button>
          <Table rowKey="id" dataSource={detail.peers||[]} columns={columnsPeer} pagination={false}/>
        </>}
      ]}/>

      <Modal open={entryOpen} onCancel={()=>setEntryOpen(false)} onOk={addEntry} title="添加入口">
        <Form layout="vertical" form={entryForm} initialValues={{ proto:"tcp" }}>
          <Form.Item name="listen" label="监听" rules={[{required:true}]}><Input placeholder="10080"/></Form.Item>
          <Form.Item name="proto" label="协议"><Input/></Form.Item>
          <Form.Item name="exit" label="出口节点" rules={[{required:true}]}><Input placeholder="node-b"/></Form.Item>
          <Form.Item name="remote" label="远端" rules={[{required:true}]}><Input placeholder="1.1.1.1:3389"/></Form.Item>
        </Form>
      </Modal>

      <Modal open={peerOpen} onCancel={()=>setPeerOpen(false)} onOk={addPeer} title="添加对端">
        <Form layout="vertical" form={peerForm}>
          <Form.Item name="peer_name" label="对端名称" rules={[{required:true}]}><Input/></Form.Item>
          <Form.Item name="entry_ip" label="入口IP"><Input placeholder="10.0.0.2"/></Form.Item>
          <Form.Item name="exit_ip" label="出口IP"><Input placeholder="10.0.0.1"/></Form.Item>
          <Form.Item name="endpoint" label="WS地址" rules={[{required:true}]}><Input placeholder="wss://host:port/mesh"/></Form.Item>
        </Form>
      </Modal>
    </Card>
  );
}

function App(){
  const [selected, setSelected] = useState(null);
  const [refreshTick, setRefreshTick] = useState(0);
  const reloadList = ()=> setRefreshTick(t=>t+1);

  return (
    <Layout style={{minHeight:"100vh"}}>
      <Layout.Header style={{color:"#fff", fontSize:18}}>ARouter 控制台</Layout.Header>
      <Layout.Content style={{padding:24}}>
        {selected
          ? <NodeDetail node={selected} onBack={()=>setSelected(null)} refreshList={reloadList}/>
          : <NodeList onSelect={setSelected} key={refreshTick}/>
        }
      </Layout.Content>
    </Layout>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
{{ end }}
